<div>
  书名: <%=@exercise.book.name if @exercise.book%>,
  章节: <%=@exercise.section.name if @exercise.section%><br/>
  类别: <%=@exercise.qtype.name if @exercise.qtype%><br/>
  题型: <%=@exercise.category.name if @exercise.category%><br/>

</div>
<div>
  <%=@exercise.exercise_text.content if @exercise.exercise_text%>
  <div><%= @exercise.title %> </div>
  <div>
    <% if @exercise.is_multi_choice? %>
        <% @exercise.options.each_with_index do |o, i| %>
            (<%=ExerciseOption::OPTION_NUM[i]%>)<%=o.name%>
        <% end %>
    <% end %>
  </div>
  <%=@exercise.note%>
</div>
<div id="answerWrapper" style="display:block">
<% if !@exercise.photo_file_name.nil? %>
  <div id="canvasContainer" style="display:inline-block">
    <canvas id="canvas" width="600" height="400"></canvas>
  </div>
  <div id="toolBox"style="display: inline-block; margin-left: 10px; vertical-align: top;">
    <button id="clearCanvas" >清除</button>
    <button id="saveCanvas" >保存</button>
    <button id="loadCanvas" >打开</button><br/>
    <label for="drawing-line-width">线宽:</label>
    <span class="info">1</span><input type="range" value="1" min="0" max="20" id="drawing-line-width"><br>

    <label for="drawing-color">线颜色:</label>
    <input type="color" value="#005E7A" id="drawing-color"><br>

  </div>
  <%= image_tag @exercise.photo.url, {:id=>"photo", :style => "display:none"} %>
  <script type="text/javascript">
        var canvas = new fabric.Canvas('canvas', {isDrawingMode: true});
        var photo = $('#photo')[0];
        var clearEl = $('#clearCanvas')[0];
        var saveEl = $('#saveCanvas')[0];
        var loadEl = $('#loadCanvas')[0];
        var drawingColorEl = $('#drawing-color')[0];
        var drawingLineWidthEl = $('#drawing-line-width')[0];

        var imgInstance = new fabric.Image(photo, {
            left:0,
            top:0
        });
        canvas.add(imgInstance);

        clearEl.onclick = function() { canvas.clear();canvas.add(imgInstance); };
        drawingColorEl.onchange = function() {
            canvas.freeDrawingBrush.color = this.value;
        };
        drawingLineWidthEl.onchange = function() {
            canvas.freeDrawingBrush.width = parseInt(this.value, 10) || 1;
            this.previousSibling.innerHTML = this.value;
        };

        saveEl.onclick = function() {
            var str = JSON.stringify(canvas);
            $.ajax({
                url: "<%=save_canvas_path(@exercise)%>",
                type: "post",
                data: {
                    data: str
                }
            });
        }
        loadEl.onclick = function() {
            var str;
            $.get("<%=load_canvas_path(@exercise)%>", function(data, textStatus) {
                canvas.loadFromJSON(data, canvas.renderAll.bind(canvas));
            });
        }

  </script>
<% end %>
</div>
<div>
  答案:
  <% if @exercise.answerphoto_file_name.nil? %>
      <%= @exercise.answer %>
  <% else %>
      <%= image_tag @exercise.answerphoto.url  %>
  <% end %>
</div>
<p>
  <%= link_to '修改', edit_exercise_path(@exercise) %>
  |
  <%= link_to '答题', answer_exercise_path(@exercise) %>
  |
  <%= link_to '返回列表', section_exercises_path(@exercise.section) %>
</p>


